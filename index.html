<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מערכת שעות</title>

  <!-- ספריות נטענות מקומית -->
  <script src="/xlsx.full.min.js"></script>
  <script src="/jspdf.umd.min.js"></script>
  <script src="/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* עיצוב מלא */
    :root {
      --bg:#f9fafb;--panel:#fff;--panel-2:#f3f4f6;
      --text:#1f2937;--muted:#6b7280;
      --accent:#3b82f6;--green:#22c55e;--yellow:#f59e0b;--red:#ef4444;
      --weekend:#fff2f2;--border:#d1d5db;--hover:#e0f2fe;
      --font-family:"Assistant","Rubik",Arial,sans-serif;
    }
    body{background:var(--bg);color:var(--text);font-family:var(--font-family);margin:0;}
    header{padding:16px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;justify-content:flex-end;}
    .icon-btn{background:var(--panel-2);border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer;}
    .toolbar{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:16px;background:var(--panel);}
    .group{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;gap:10px;flex-wrap:wrap;}
    button{border:1px solid var(--border);border-radius:12px;padding:9px 12px;cursor:pointer;}
    .primary{background:var(--accent);color:#fff;} .success{background:var(--green);color:#fff;} .warn{background:var(--yellow);color:#fff;}
    main{padding:16px;}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;}
    .stat{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;}
    .stat .label{font-size:12px;color:var(--muted);} .stat .value{font-size:22px;color:var(--accent);font-weight:800;}
    .alerts{margin:8px 0;} .alert{background:var(--panel-2);border:1px dashed var(--border);padding:10px;border-radius:10px;margin-bottom:8px;}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:14px;}
    thead th{background:var(--panel-2);padding:10px;} tbody td{padding:8px;border-bottom:1px solid var(--border);}
    tbody tr:nth-child(even){background:#f9fafb;} tr.weekend{background:var(--weekend);}
    tr.status-ok{background:#dcfce7;} tr.status-warn{background:#fef9c3;} tr.status-danger{background:#fee2e2;}
  </style>
</head>
<body>
  <header><div id="openSettings" class="icon-btn">⚙️ הגדרות</div></header>

  <section class="toolbar">
    <div class="group" style="grid-column: span 4;">
      <label>חודש</label><select id="month"></select>
      <label>שנה</label><select id="year"></select>
      <button id="generate" class="primary">צור טבלה</button>
    </div>
    <div class="group" style="grid-column: span 4;">
      <label>קובץ Excel של פיל</label>
      <input type="file" id="fileInput" accept=".xlsx,.xls"/>
      <button id="importExcel" class="success">ייבוא</button>
    </div>
    <div class="group" style="grid-column: span 4;">
      <button id="templateFill" class="primary">מלא חודש רגיל</button>
      <button id="templateCopy" class="primary">העתק מפיל למתן</button>
      <button id="clearAll" class="warn">ניקוי הכל</button>
      <button id="exportExcel" class="success">ייצוא ל־Excel</button>
      <button id="exportPDF" class="warn">ייצוא ל־PDF</button>
    </div>
  </section>

  <main>
    <section class="stats">
      <div class="stat"><div class="label">סה״כ שעות מתן</div><div id="statMatan" class="value">0:00</div></div>
      <div class="stat"><div class="label">סה״כ שעות פיל</div><div id="statPhil" class="value">0:00</div></div>
      <div class="stat"><div class="label">פער שעות</div><div id="statDelta" class="value">0:00</div></div>
      <div class="stat"><div class="label">ימי עבודה / חופשה / מחלה / חג</div><div id="statDays" class="value">0 / 0 / 0 / 0</div></div>
    </section>

    <section class="alerts" id="alerts"></section>

    <table id="hoursTable">
      <thead>
        <tr>
          <th>תאריך</th><th>יום</th>
          <th>כניסה (פיל)</th><th>יציאה (פיל)</th><th>סה״כ (פיל)</th>
          <th>כניסה (מתן)</th><th>יציאה (מתן)</th><th>סה״כ (מתן)</th>
          <th>סוג יום</th><th>סטטוס</th><th>הערות</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </main>

  <script>
    // בדיקה שהספריות נטענו
    console.log("XLSX loaded?", typeof XLSX);
    console.log("jsPDF loaded?", typeof window.jspdf);

    const pad2 = n => n<10?"0"+n:n;
    const minutesToHHMM = m => {const h=Math.floor(m/60),min=m%60;return h+":"+pad2(min);};
    const parseTime = v => {if(!v)return 0;const [h,m]=v.split(":").map(Number);return h*60+m;};

    let state={year:new Date().getFullYear(),month:new Date().getMonth(),rows:[]};

    function buildMonthTable(y,m){
      const tbody=document.getElementById("tableBody");tbody.innerHTML="";
      const days=new Date(y,m+1,0).getDate();
      state.rows=[];
      for(let d=1;d<=days;d++){
        const date=new Date(y,m,d);
        const key=`${y}-${pad2(m+1)}-${pad2(d)}`;
        const tr=document.createElement("tr");
        tr.dataset.key=key;
        tr.innerHTML=`<td>${key}</td><td>${date.toLocaleDateString("he-IL",{weekday:"short"})}</td>
        <td><input type="time" class="phil-in"></td><td><input type="time" class="phil-out"></td><td
